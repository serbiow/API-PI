,r&&(r[t]=n),n},r}function fi(n,t,i){return i!==undefined?"("+n+";"+t+";"+i+")":t!==undefined?"("+n+";"+t+")":n!==undefined?"("+n+")":""}function tt(n,t,i,r){o("WinJS.Scheduler:"+n+fi(i,r)+","+t)}function v(n,t,i,r,u){var f=n.name||r!==undefined||u!==undefined;o("WinJS.Scheduler:"+t+":"+n.id+(f?fi(n.name,r,u):"")+","+i)}function c(){return!1}function ft(n){throw"Illegal call by job("+n.id+") in state: "+this.name;}function g(n){return function(t,i,r){t._setState(n,i,r)}}function wt(n,t){n._setPriority(t)}function lr(n,t){function f(n,t){u.log&&u.log(t+": MARKER: "+n.name,"winjs scheduler","log")}function e(n,t){u.log&&u.log(t+": JOB("+n.id+"): state: "+(n._state?n._state.name:"")+(n.name?", name: "+n.name:""),"winjs scheduler","log")}u.log&&u.log("highWaterMark: "+a,"winjs scheduler","log");var r=0,o=t?bt[bt.length-1]:bt[0],i=o;do i instanceof h&&f(i,r),i instanceof it&&e(i,r),r++,i=t?i["_prev"+n]:i["_next"+n];while(i)}function ar(){function u(t,i){n+="    "+(i?"*":" ")+"id: "+t.id+", priority: "+w(t.priority).name+(t.name?", name: "+t.name:"")+"\n"}var n="",t,r,i,f;for(n+="Jobs:\n",t=w(a),r=0,pt&&(u(pt,!0),r++);t.priority>=p.min;)t instanceof it&&(u(t,!1),r++),t=t._nextJob;for(r===0&&(n+="     None\n"),n+="Drain requests:\n",i=0,f=y.length;i<f;i++)n+="    "+(i===0?"*":" ")+"priority: "+w(y[i].priority).name+", name: "+y[i].name+"\n";return y.length===0&&(n+="     None\n"),n}function vr(){var n=bt[0];do{if(n instanceof it)return!1;n=n._nextJob}while(n);return!0}function rr(){return y.length===0?null:y[0].priority}function si(n){tt("drain","StartTM",n.name,w(n.priority).name)}function ur(n,t){t&&tt("drain-canceled","info",n.name,w(n.priority).name);tt("drain","StopTM",n.name,w(n.priority).name)}function yr(n,t,i){y.push({priority:n,complete:t,name:i});y.length===1&&(si(y[0]),n>a&&(a=n,ct=!0))}function pr(n,t){for(var r=y.length,i=0;i<r;i++)if(y[i].complete===n){i===0&&(ur(y[0],t),y[1]&&si(y[1]));y.splice(i,1);break}}function wr(){var n=y.shift();n&&(ur(n),y[0]&&si(y[0]),n.complete())}function fr(){var t=!1,n;if(!!y.length)for(n=rr();+n===n&&n>a;)kt=n,wr(),t=!0,n=rr();return t}function gt(n){return n>=p.aboveNormal+1?l.HIGH:n>=p.belowNormal?l.NORMAL:l.IDLE}function kr(n,t){return lt[n]>=lt[t]}function dr(n,t){return lt[n]>lt[t]}function er(n){switch(n){case l.HIGH:return!1;case l.NORMAL:return l.isTaskScheduledAtPriorityOrHigher(l.HIGH);case l.IDLE:return l.isTaskScheduledAtPriorityOrHigher(l.NORMAL)}}function gr(n,t){var i=w(t);i.priority>a&&(a=i.priority,ct=!0);i._insertJobAfter(n)}function ci(n,t){var i=w(t);i.priority>a&&(a=i.priority,ct=!0);i._nextMarker._insertJobBefore(n)}function li(n){return n=n|0,n=Math.max(n,cr),Math.min(n,tr)}function w(n){return n=li(n),bt[-1*(n-tr)]}function nu(n){var c,s,e,b;ni=!0;tt("timeslice","StartTM");var r,u=!0,t,i,o=!1,f=!1;ct=!1;try{for(var k=ai(),d=k+ir,h=function(){return(o=!1,ct)?!0:er(gt(a))?!0:!y.length?ai()>d?(o=!0,!0):!1:!1};a>=p.min&&!h()&&!f;){r=!1;t=w(a)._nextJob;do kt=t.priority,t instanceof it?(i!==t.priority&&(+i===i&&tt("priority","StopTM",w(i).name),tt("priority","StartTM",w(t.priority).name),i=t.priority),r=!0,u=!1,pt=t,v(pt,"job-running","StartTM",w(kt).name),t._execute(h),v(pt,"job-running","StopTM",w(kt).name),pt=null,u=!0):(c=gt(a),a=t.priority,r=fr(),s=gt(a),dr(c,s)&&(!dt||l.isTaskScheduledAtPriorityOrHigher(s))&&(f=!0)),t=t._nextJob;while(t&&!r&&!f&&!er(gt(a)));ct=!1}}finally{for(pt=null,u||(v(t,"job-error","info"),v(t,"job-running","StopTM",w(kt).name),t.cancel()),+i===i&&tt("priority","StopTM",w(i).name),e=!1;a>=p.min&&!e;){r=!1;t=w(a)._nextJob;do t instanceof it?e=!0:(a=t.priority,r=fr()),t=t._nextJob;while(t&&!r&&!e)}b=u?o?"timeslice exhausted":a<p.min?"jobs exhausted":f?"reached WWA priority boundary":"WWA host work":"job error";n&&(ui=null);ni=!1;a>=p.min&&pi();tt("yielding","info",b);tt("timeslice","StopTM")}}function pi(n){var t,i,r;(+n!==n&&(n=a),t=gt(n),ni)||ui&&(!dt||kr(ui,t))||(i=++vi,r=function(){yi<i&&(yi=vi,nu(!0))},l.execAsyncAtPriority(r,t),ui=t)}function tu(n,t){var u=hr++,i,r;return t===undefined&&(t="Drain Request "+u),n=+n===n?n:p.min,n=li(n),r=new s(function(r){i=r;yr(n,i,t)},function(){pr(i,!0)}),ni||pi(),r}function iu(n){return l.execAtPriority(n,l.HIGH)}function ru(){return new ki}function or(n,t,i,r){t=t||p.normal;i=i||null;var u=++sr,f=e._traceAsyncOperationStarting("WinJS.Utilities.Scheduler.schedule: "+u+fi(r));return r=r||"",new it(u,n,t,i,r,f)}function uu(){if(ni)return kt;switch(l.getCurrentPriority()){case l.HIGH:return p.high;case l.NORMAL:return p.normal;case l.IDLE:return p.idle}}function ti(n){return function(t,i){var r;return new s(function(u){r=or(function(){u(t)},n,null,i)},function(){r.cancel()})}}var wi,it,h,lt,ai,vi,yi;i.Namespace.define("WinJS.Utilities",{_linkedListMixin:ii});wi={get jobInfoIsNoLongerValid(){return"The job info object can only be used while the job is running"}};it=i.Class.define(function(n,t,i,r,u,f){this._id=n;this._work=t;this._context=r;this._name=u;this._asyncOpID=f;this._setPriority(i);this._setState(di);v(this,"job-scheduled","info")},{completed:{get:function(){return!!this._state.completed}},id:{get:function(){return this._id}},name:{get:function(){return this._name},set:function(n){this._name=n}},owner:{get:function(){return this._owner},set:function(n){this._owner&&this._owner._remove(this);this._owner=n;this._owner&&this._owner._add(this)}},priority:{get:function(){return this._priority},set:function(n){n=li(n);this._state.setPriority(this,n)}},cancel:function(){this._state.cancel(this)},pause:function(){this._state.pause(this)},resume:function(){this._state.resume(this)},_execute:function(n){this._state.execute(this,n)},_executeDone:function(n){return this._state.executeDone(this,n)},_blockedDone:function(n){return this._state.blockedDone(this,n)},_setPriority:function(n){+this._priority===this._priority&&this._priority!==n&&v(this,"job-priority-changed","info",w(this._priority).name,w(n).name);this._priority=n},_setState:function(n,t,i){this._state&&u.log&&u.log("Transitioning job ("+this.id+") from: "+this._state.name+" to: "+n.name,"winjs scheduler","log");this._state=n;this._state.enter(this,t,i)}});i.Class.mix(it,ii("Job"));var k={complete:1,"continue":2,block:3},bi=i.Class.define(function(n,t){this._job=t;this._result=null;this._yieldPolicy=k.complete;this._shouldYield=n},{job:{get:function(){return this._throwIfDisabled(),this._job}},shouldYield:{get:function(){return this._throwIfDisabled(),this._shouldYield()}},setPromise:function(n){this._throwIfDisabled();this._result=n;this._yieldPolicy=k.block},setWork:function(n){this._throwIfDisabled();this._result=n;this._yieldPolicy=k.continue},_disablePublicApi:function(){this._publicApiDisabled=!0},_throwIfDisabled:function(){if(this._publicApiDisabled)throw new r("WinJS.Utilities.Scheduler.JobInfoIsNoLongerValid",wi.jobInfoIsNoLongerValid);}}),ki=i.Class.define(function(){this._jobs={}},{cancelAll:function(){var t=this._jobs,i=Object.keys(t),n,r;for(this._jobs={},n=0,r=i.length;n<r;n++)t[i[n]].cancel()},_add:function(n){this._jobs[n.id]=n},_remove:function(n){delete this._jobs[n.id]}});var b=i.Class.define(function(n){this.name=n;this.enter=ft;this.execute=ft;this.executeDone=ft;this.blockedDone=ft;this.cancel=ft;this.pause=ft;this.resume=ft;this.setPriority=ft}),di=new b("created"),rt=new b("scheduled"),at=new b("paused"),d=new b("canceled"),vt=new b("running"),et=new b("running_paused"),yt=new b("running_resumed"),ut=new b("running_canceled"),gi=new b("running_canceled_blocked"),ri=new b("cooperative_yield"),ei=new b("cooperative_yield_paused"),oi=new b("blocked"),ot=new b("blocked_waiting"),nr=new b("blocked_paused"),st=new b("blocked_paused_waiting"),ht=new b("blocked_canceled"),nt=new b("complete");di.enter=function(n){ci(n,n.priority);n._setState(rt)};rt.enter=function(){pi()};rt.execute=g(vt);rt.cancel=g(d);rt.pause=g(at);rt.resume=c;rt.setPriority=function(n,t){n.priority!==t&&(n._setPriority(t),n.pause(),n.resume())};at.enter=function(n){v(n,"job-paused","info");n._removeJob()};at.cancel=g(d);at.pause=c;at.resume=function(n){v(n,"job-resumed","info");ci(n,n.priority);n._setState(rt)};at.setPriority=wt;d.enter=function(n){v(n,"job-canceled","info");e._traceAsyncOperationCompleted(n._asyncOpID,t.Debug&&t.Debug.MS_ASYNC_OP_STATUS_CANCELED);n._removeJob();n._work=null;n._context=null;n.owner=null};d.cancel=c;d.pause=c;d.resume=c;d.setPriority=c;vt.enter=function(n,t){var i,f;n._removeJob();var r=n.priority,o=n._work,u=n._context;n._work=null;n._context=null;i=new bi(t,n);e._traceAsyncCallbackStarting(n._asyncOpID);try{l.execAtPriority(function(){o.call(u,i)},gt(r))}finally{e._traceAsyncCallbackCompleted();i._disablePublicApi()}n._context=u;f=n._executeDone(i._yieldPolicy);n._setState(f,i._result,r)};vt.executeDone=function(n,t){switch(t){case k.complete:return nt;case k.continue:return ri;case k.block:return oi}};vt.cancel=function(n){ct=!0;n._setState(ut)};vt.pause=function(n){ct=!0;n._setState(et)};vt.resume=c;vt.setPriority=wt;et.enter=c;et.executeDone=function(n,t){switch(t){case k.complete:return nt;case k.continue:return ei;case k.block:return nr}};et.cancel=g(ut);et.pause=c;et.resume=g(yt);et.setPriority=wt;yt.enter=c;yt.executeDone=function(n,t){switch(t){case k.complete:return nt;case k.continue:return ri;case k.block:return oi}};yt.cancel=g(ut);yt.pause=g(et);yt.resume=c;yt.setPriority=wt;ut.enter=c;ut.executeDone=function(n,t){switch(t){case k.complete:case k.continue:return d;case k.block:return gi}};ut.cancel=c;ut.pause=c;ut.resume=c;ut.setPriority=c;gi.enter=function(n,t){t.cancel();n._setState(d)};ri.enter=function(n,t,i){v(n,"job-yielded","info");i===n.priority?gr(n,n.priority):ci(n,n.priority);n._work=t;n._setState(rt)};ei.enter=function(n,t){v(n,"job-yielded","info");n._work=t;n._setState(at)};oi.enter=function(n,t,i){v(n,"job-blocked","StartTM");n._work=t;n._setState(ot);t.done(function(t){v(n,"job-blocked","StopTM");var r=n._blockedDone(t);n._setState(r,t,i)},function(t){return t&&t.name==="Canceled"||v(n,"job-error","info"),v(n,"job-blocked","StopTM"),n._setState(d),s.wrapError(t)})};ot.enter=c;ot.blockedDone=function(n,t){return typeof t=="function"?ri:nt};ot.cancel=g(ht);ot.pause=g(st);ot.resume=c;ot.setPriority=wt;nr.enter=function(n,t,i){v(n,"job-blocked","StartTM");n._work=t;n._setState(st);t.done(function(t){v(n,"job-blocked","StopTM");var r=n._blockedDone(t);n._setState(r,t,i)},function(t){return t&&t.name==="Canceled"||v(n,"job-error","info"),v(n,"job-blocked","StopTM"),n._setState(d),s.wrapError(t)})};st.enter=c;st.blockedDone=function(n,t){return typeof t=="function"?ei:nt};st.cancel=g(ht);st.pause=c;st.resume=g(ot);st.setPriority=wt;ht.enter=function(n){n._work.cancel();n._work=null};ht.blockedDone=function(){return d};ht.cancel=c;ht.pause=c;ht.resume=c;ht.setPriority=c;nt.completed=!0;nt.enter=function(n){e._traceAsyncOperationCompleted(n._asyncOpID,t.Debug&&t.Debug.MS_ASYNC_OP_STATUS_SUCCESS);n._work=null;n._context=null;n.owner=null;v(n,"job-completed","info")};nt.cancel=c;nt.pause=c;nt.resume=c;nt.setPriority=c;h=i.Class.define(function(n,t){this.priority=n;this.name=t},{});i.Class.mix(h,ii("Job"),ii("Marker"));var sr=0,hr=0,cr=-15,tr=15,p={max:15,high:13,aboveNormal:9,normal:0,belowNormal:-9,idle:-13,min:-15},bt=[new h(15,"max"),new h(14,"14"),new h(13,"high"),new h(12,"12"),new h(11,"11"),new h(10,"10"),new h(9,"aboveNormal"),new h(8,"8"),new h(7,"7"),new h(6,"6"),new h(5,"5"),new h(4,"4"),new h(3,"3"),new h(2,"2"),new h(1,"1"),new h(0,"normal"),new h(-1,"-1"),new h(-2,"-2"),new h(-3,"-3"),new h(-4,"-4"),new h(-5,"-5"),new h(-6,"-6"),new h(-7,"-7"),new h(-8,"-8"),new h(-9,"belowNormal"),new h(-10,"-10"),new h(-11,"-11"),new h(-12,"-12"),new h(-13,"idle"),new h(-14,"-14"),new h(-15,"min"),new h(-16,"<TAIL>")];var ui=null,ni,kt,pt=null,dt=!!(t.MSApp&&t.MSApp.execAtPriority),y=[],ct,ir=30,a=p.min;bt.reduce(function(n,t){return n&&(n._insertJobAfter(t),n._insertMarkerAfter(t)),t});var br=t.setImmediate?t.setImmediate.bind(t):function(n){t.setTimeout(n,16)},hi={execAsyncAtPriority:function(n,i){i===l.HIGH&&t.setTimeout(n,0);br(n)},execAtPriority:function(n){return n()},getCurrentPriority:function(){return hi.NORMAL},isTaskScheduledAtPriorityOrHigher:function(){ret